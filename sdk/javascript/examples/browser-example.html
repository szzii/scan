<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Service Client - Browser Example</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 18px;
            color: #555;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .scanner-list, .job-list {
            list-style: none;
        }

        .scanner-item, .job-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
        }

        .scanner-item h3, .job-item h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .scanner-item p, .job-item p {
            font-size: 14px;
            color: #666;
            margin: 4px 0;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: #333;
        }

        .log-entry.info {
            color: #0066cc;
        }

        .log-entry.success {
            color: #2e7d32;
        }

        .log-entry.error {
            color: #c62828;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scanner Service Client SDK</h1>
        <p style="color: #666; margin-bottom: 20px;">Browser Example</p>

        <div id="connectionStatus" class="status disconnected">
            WebSocket: Disconnected
        </div>

        <div class="section">
            <h2>Actions</h2>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="disconnectWebSocket()">Disconnect WebSocket</button>
            <button onclick="loadScanners()">Load Scanners</button>
            <button onclick="checkHealth()">Check Health</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="section">
            <h2>Available Scanners</h2>
            <ul id="scannerList" class="scanner-list">
                <li style="color: #999; padding: 15px;">No scanners loaded. Click "Load Scanners" button.</li>
            </ul>
        </div>

        <div class="section">
            <h2>Create Scan</h2>
            <div class="form-group">
                <label>Scanner</label>
                <select id="scannerSelect">
                    <option value="">Select a scanner...</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Resolution (DPI)</label>
                    <select id="resolution">
                        <option value="150">150</option>
                        <option value="300" selected>300</option>
                        <option value="600">600</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Color Mode</label>
                    <select id="colorMode">
                        <option value="Color" selected>Color</option>
                        <option value="Grayscale">Grayscale</option>
                        <option value="BlackAndWhite">Black & White</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Format</label>
                    <select id="format">
                        <option value="PDF" selected>PDF</option>
                        <option value="JPEG">JPEG</option>
                        <option value="PNG">PNG</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pages</label>
                    <input type="number" id="pageCount" value="1" min="1" max="10">
                </div>
            </div>

            <button onclick="startScan()">Start Scan</button>
            <button onclick="startBatchScan()">Start Batch Scan (3x)</button>
        </div>

        <div class="section">
            <h2>Activity Log</h2>
            <div id="log" class="log">
                <div class="log-entry">Ready. Click "Connect WebSocket" to start.</div>
            </div>
        </div>
    </div>

    <script src="../src/scanner-client.js"></script>
    <script>
        // Configuration
        const SERVICE_URL = 'http://localhost:8080';

        // Global client instance
        let client = null;
        let scanners = [];

        // Initialize
        function init() {
            client = new ScannerClient(SERVICE_URL, {
                autoReconnect: true,
                reconnectInterval: 3000
            });

            // Register event listeners
            client.on('connected', () => {
                updateConnectionStatus(true);
                log('WebSocket connected', 'success');
            });

            client.on('disconnected', () => {
                updateConnectionStatus(false);
                log('WebSocket disconnected', 'error');
            });

            client.on('job_status', (job) => {
                log(`Job ${job.id.substring(0, 8)}... status: ${job.status} (${job.progress}%)`, 'info');
            });

            client.on('scanner_status', (scanner) => {
                log(`Scanner ${scanner.id} status: ${scanner.status}`, 'info');
            });

            client.on('error', (error) => {
                log(`WebSocket error: ${error}`, 'error');
            });

            log('SDK initialized', 'success');
        }

        // Connect WebSocket
        async function connectWebSocket() {
            try {
                log('Connecting to WebSocket...', 'info');
                await client.connectWebSocket();
            } catch (error) {
                log(`Failed to connect: ${error.message}`, 'error');
            }
        }

        // Disconnect WebSocket
        function disconnectWebSocket() {
            client.disconnectWebSocket();
            log('WebSocket disconnected', 'info');
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'WebSocket: Connected';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'WebSocket: Disconnected';
            }
        }

        // Load scanners
        async function loadScanners() {
            try {
                log('Loading scanners...', 'info');
                scanners = await client.listScanners();
                log(`Found ${scanners.length} scanner(s)`, 'success');
                renderScanners();
            } catch (error) {
                log(`Failed to load scanners: ${error.message}`, 'error');
            }
        }

        // Render scanners list
        function renderScanners() {
            const list = document.getElementById('scannerList');
            const select = document.getElementById('scannerSelect');

            if (scanners.length === 0) {
                list.innerHTML = '<li style="color: #999; padding: 15px;">No scanners found</li>';
                select.innerHTML = '<option value="">No scanners available</option>';
                return;
            }

            // Render list
            list.innerHTML = scanners.map(scanner => `
                <li class="scanner-item">
                    <h3>${scanner.name}</h3>
                    <p><strong>ID:</strong> ${scanner.id}</p>
                    <p><strong>Model:</strong> ${scanner.manufacturer} ${scanner.model}</p>
                    <p><strong>Status:</strong> ${scanner.status}</p>
                </li>
            `).join('');

            // Update select
            select.innerHTML = '<option value="">Select a scanner...</option>' +
                scanners.map(scanner => `<option value="${scanner.id}">${scanner.name}</option>`).join('');
        }

        // Start scan
        async function startScan() {
            const scannerId = document.getElementById('scannerSelect').value;
            if (!scannerId) {
                alert('Please select a scanner');
                return;
            }

            const params = {
                resolution: parseInt(document.getElementById('resolution').value),
                color_mode: document.getElementById('colorMode').value,
                format: document.getElementById('format').value,
                page_count: parseInt(document.getElementById('pageCount').value)
            };

            try {
                log(`Starting scan with ${params.resolution} DPI, ${params.color_mode}, ${params.format}...`, 'info');
                const job = await client.createScan(scannerId, params);
                log(`Scan job created: ${job.id}`, 'success');
            } catch (error) {
                log(`Failed to start scan: ${error.message}`, 'error');
            }
        }

        // Start batch scan
        async function startBatchScan() {
            const scannerId = document.getElementById('scannerSelect').value;
            if (!scannerId) {
                alert('Please select a scanner');
                return;
            }

            const params = {
                resolution: parseInt(document.getElementById('resolution').value),
                color_mode: document.getElementById('colorMode').value,
                format: document.getElementById('format').value,
                page_count: parseInt(document.getElementById('pageCount').value)
            };

            try {
                log('Starting batch scan (3 scans)...', 'info');
                const result = await client.createBatchScan(scannerId, params, 3);
                log(`Batch scan created: ${result.job_ids.length} jobs`, 'success');
            } catch (error) {
                log(`Failed to start batch scan: ${error.message}`, 'error');
            }
        }

        // Check health
        async function checkHealth() {
            try {
                log('Checking service health...', 'info');
                const health = await client.healthCheck();
                log(`Service status: ${health.status}`, 'success');
            } catch (error) {
                log(`Health check failed: ${error.message}`, 'error');
            }
        }

        // Log message
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Clear log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
