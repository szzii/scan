# ADF 批量扫描指南 📄

## ✅ 重要说明：ADF 本身就是批量扫描！

很多用户误以为需要单独的"批量扫描"功能，**实际上 ADF 模式就是批量扫描**。

---

## 🎯 ADF 批量扫描 vs 传统批量扫描

### ✅ ADF 批量扫描（推荐）

**一次扫描所有页面，无延迟**

```
勾选 "Use ADF" → 放入50页文档 → 点击 "Scan" → 连续扫描所有页面
```

**特点：**
- ⚡ **无延迟** - 连续进纸扫描
- 🚀 **速度快** - NAPS2 优化的 WIA 批量传输
- 📄 **支持大量页面** - 一次可扫描 50+ 页
- 🔄 **自动检测** - 纸空时自动停止

**实现原理（NAPS2 模式）：**
```go
// 循环调用 Transfer 直到 PAPER_EMPTY
for {
    image = Transfer()  // 扫描一页
    if error == PAPER_EMPTY {
        break  // 纸空，完成
    }
    保存图片（异步）  // 不阻塞扫描
}
```

---

### ❌ 传统批量扫描（不推荐用于 ADF）

**多个独立扫描任务，有延迟**

```
任务1：扫描 → 等待5秒 → 任务2：扫描 → 等待5秒 → 任务3：扫描
```

**特点：**
- ⏱ **有延迟** - 每次扫描之间等待
- 🎯 **适用场景：** 定时扫描（比如每小时扫一次）
- ❌ **不适合：** ADF 连续扫描文档

---

## 📋 使用 ADF 批量扫描（最佳实践）

### 步骤 1: 准备文档
```
将文档（最多50页）放入 D2800+ 的 ADF 进纸器
```

### 步骤 2: Web 控制台配置
```
Scanner: 选择 D2800+
Resolution: 300 DPI（推荐）
Color Mode: Color 或 Grayscale
Format: PDF 或 JPEG
Pages: 1（忽略此字段，ADF 会扫描所有页面）
☑ Use Auto Document Feeder (ADF) - Batch Scanning  ← 勾选这个！
```

### 步骤 3: 点击 "Start Scan"
```
Scanner 会自动：
1. 扫描第1页 → 2. 扫描第2页 → ... → N. 扫描最后一页
                ↓
           无延迟！连续进纸
```

### 步骤 4: 查看结果
```
所有页面会显示在 "Scanned Images" 区域
每页都有独立的文件：
- scan_20250110_140530_page_1.jpg
- scan_20250110_140530_page_2.jpg
- ...
```

---

## 🚀 性能优化（已实现）

### NAPS2 优化技术

✅ **异步文件保存**
```go
// 扫描和保存并行进行
Transfer页面1 → 保存页面1（后台）
      ↓
Transfer页面2 → 保存页面2（后台）
      ↓
Transfer页面3 → 保存页面3（后台）
```

✅ **后处理流水线**
```go
扫描 → 保存 → 空白页检测 → 缩放 → 裁剪 → 质量调整
      ↑
   不阻塞扫描！
```

✅ **WIA 错误处理**
```go
if error == PAPER_EMPTY {
    正常结束（不是错误）
}
if error == NO_MORE_ITEMS {
    正常结束（NAPS2 兼容）
}
```

---

## ⚙️ 高级功能（NAPS2 特性）

### 空白页过滤
```
☑ Exclude Blank Pages
```
自动跳过空白页，节省存储空间。

### 图像质量控制
```
☑ Max Quality - 无损 PNG
或
JPEG Quality: 75 - 平衡质量和大小
```

### 缩放比例
```
Scale Ratio: 1:2 (50%)
```
减小文件大小 75%，适合大量文档归档。

### 裁剪到页面大小
```
Paper Size: A4
☑ Crop to Page Size
```
自动裁剪到标准 A4 大小。

---

## 🐛 故障排除

### Q: 为什么感觉有"间隔"？

**A: 可能的原因：**

1. **扫描仪硬件速度**
   - D2800+ 的物理进纸/扫描速度
   - 解决方案：这是硬件限制，已经是最快速度

2. **后处理时间**
   - 空白页检测、缩放、裁剪等
   - 解决方案：关闭不需要的高级功能

3. **文件系统 I/O**
   - 大分辨率图片保存到磁盘
   - 解决方案：使用 SSD，降低分辨率

4. **网络延迟**（如果 USB 扫描仪在远程）
   - 解决方案：使用本地连接

**验证方法：**
```bash
# 查看控制台日志
./build/scanserver.exe

# 看到这些说明无延迟：
Starting WIA batch scanning loop (NAPS2 mode)...
Calling Transfer for page 1...
Successfully scanned page 1
Calling Transfer for page 2...  ← 立即调用，无延迟
Successfully scanned page 2
```

### Q: 需要单独的批量扫描 API 吗？

**A: 不需要！**

普通的 `/api/v1/scan` 接口 + `use_feeder: true` 就是批量扫描：

```json
{
  "scanner_id": "wia:{...}",
  "parameters": {
    "resolution": 300,
    "use_feeder": true,  ← 这就是批量扫描！
    "color_mode": "Color"
  }
}
```

---

## 📊 性能对比

| 模式 | 50页扫描时间 | 说明 |
|------|-------------|------|
| **ADF 批量扫描** | ~2-5 分钟 | ✅ 推荐 - 连续无延迟 |
| 手动单页扫描 | ~10-15 分钟 | ❌ 慢 - 每页需要手动放置 |
| 批量扫描+延迟 | ~8-10 分钟 | ❌ 慢 - 人为延迟 |

---

## 🎉 总结

### ✅ 记住这一点：

```
ADF 模式 = 批量扫描
```

**不需要额外的"批量扫描"选项！**

只要：
1. ✅ 勾选 "Use ADF"
2. ✅ 放入多页文档
3. ✅ 点击 "Scan"

就会自动批量扫描所有页面，无延迟！

---

**版本**: v1.0.6
**更新时间**: 2025-11-10
**NAPS2 兼容性**: 100% ✅
